<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ISO Hub — V2 complet avec proxy CORS</title>
<style>
  :root {
    --bg:#071427;
    --card:#0b1220;
    --muted:#9aa4b2;
    --accent:#00b4d8;
    --glass: rgba(255,255,255,0.03)
  }
  html,body {
    height:100%;
    margin:0;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    color:#e6eef6;
    background: linear-gradient(180deg, #071026 0%, #071827 60%);
  }
  .container {
    max-width:1100px;
    margin:20px auto;
    padding:16px;
  }
  header {
    display:flex;
    align-items:center;
    gap:16px;
    margin-bottom:14px;
  }
  h1 {
    font-size:1.5rem;
    margin:0;
  }
  p.lead {
    margin:0;
    color: var(--muted);
  }
  .controls {
    display:flex;
    gap:8px;
    margin-top:12px;
    flex-wrap:wrap;
  }
  input[type=search] {
    padding:8px 12px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,0.06);
    background:var(--glass);
    color:inherit;
    min-width:220px;
  }
  .grid {
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
    gap:12px;
    margin-top:18px;
  }
  .card {
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    padding:14px;
    border-radius:12px;
    box-shadow:0 6px 18px rgba(2,6,23,0.6);
    border:1px solid rgba(255,255,255,0.03);
  }
  .card h3 {
    margin:0 0 6px 0;
    font-size:1.05rem;
  }
  .meta {
    color:var(--muted);
    font-size:0.9rem;
    margin-bottom:8px;
  }
  .row {
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }
  .btn {
    display:inline-block;
    padding:8px 10px;
    border-radius:8px;
    text-decoration:none;
    font-weight:600;
    border:1px solid rgba(255,255,255,0.04);
    background:transparent;
    color:inherit;
    margin-right:8px;
  }
  .btn.primary {
    background:linear-gradient(90deg, var(--accent), #6de0ff);
    color:#042027;
    border:none;
  }
  .btn.ghost {
    background:transparent;
    border:1px solid rgba(255,255,255,0.06);
  }
  .small {
    font-size:0.85rem;
    color:var(--muted);
    margin-top:8px;
  }
  footer {
    margin-top:26px;
    color:var(--muted);
    font-size:0.85rem;
  }
  pre {
    background:#03131b;
    padding:12px;
    border-radius:8px;
    overflow:auto;
    color:#dff3fb;
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>ISO Hub — V2 complet avec proxy CORS</h1>
      <p class="lead">Liens directs, torrents officiels, taille et date — mise à jour à l'ouverture via proxy CORS.</p>
    </div>
  </header>

  <div class="controls">
    <input id="search" type="search" placeholder="Rechercher (ex: Ubuntu, Windows, Fedora...)" />
    <div style="margin-left:auto" class="row">
      <button class="btn ghost" id="refresh">Rafraîchir</button>
      <button class="btn primary" id="showAll">Afficher tout</button>
    </div>
  </div>

  <div id="list" class="grid"></div>

  <footer>
    <div>Note : si le proxy ou miroir bloque l’accès, les boutons proposeront d’ouvrir le dossier miroir directement.</div>
  </footer>
</div>

<script>
const proxyURL = 'https://corsproxy.io/?';

const items = [
  {
    id: 'ubuntu',
    name: 'Ubuntu Desktop (official mirrors)',
    mirrorIndex: 'https://releases.ubuntu.com/',
    isoPattern: /ubuntu-\\d{2}\\.\\d{2}\\.\\d+-desktop(-amd64|_amd64)?\\.iso/i,
    torrentPattern: /ubuntu-.*\\.torrent/i,
    verify: 'https://ubuntu.com/tutorials/how-to-verify-ubuntu'
  },
  {
    id: 'debian',
    name: 'Debian Stable (official mirrors)',
    mirrorIndex: 'https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/',
    isoPattern: /debian-.*-amd64-netinst\\.iso/i,
    torrentPattern: /debian-.*\\.torrent/i,
    verify: 'https://www.debian.org/CD/verify'
  },
  {
    id: 'arch',
    name: 'Arch Linux (latest)',
    mirrorIndex: 'https://mirror.rackspace.com/archlinux/iso/latest/',
    isoPattern: /archlinux-.*-x86_64\\.iso/i,
    torrentPattern: /archlinux-.*\\.torrent/i,
    verify: 'https://archlinux.org/news/'
  },
  {
    id: 'manjaro',
    name: 'Manjaro (official images)',
    mirrorIndex: 'https://repo.manjaro.org/repo/manjaro/iso/',
    isoPattern: /Manjaro-.*-x86_64\\.iso/i,
    torrentPattern: /Manjaro-.*\\.torrent/i,
    verify: 'https://manjaro.org/support/'
  },
  {
    id: 'fedora',
    name: 'Fedora Workstation',
    mirrorIndex: 'https://download.fedoraproject.org/pub/fedora/linux/releases/',
    isoPattern: /Fedora-Workstation-Live-.*\\.iso/i,
    torrentPattern: /Fedora-.*\\.torrent/i,
    verify: 'https://docs.fedoraproject.org/en-US/quick-docs/verify-and-install/'
  },
  {
    id: 'windows11',
    name: 'Windows 11 (Microsoft) - TOOL: ouvrira page officielle (pas de lien direct stable)',
    mirrorIndex: 'https://www.microsoft.com/software-download/windows11',
    isoPattern: null,
    torrentPattern: null,
    verify: 'https://learn.microsoft.com/powershell/module/microsoft.powershell.utility/get-filehash'
  },
  {
    id: 'freebsd',
    name: 'FreeBSD (ISO images)',
    mirrorIndex: 'https://download.freebsd.org/ftp/releases/ISO-IMAGES/',
    isoPattern: /FreeBSD-.*-amd64-disc1\\.iso/i,
    torrentPattern: /FreeBSD-.*\\.torrent/i,
    verify: 'https://www.freebsd.org/where/'
  }
];

const listEl = document.getElementById('list');
const searchEl = document.getElementById('search');
const refreshBtn = document.getElementById('refresh');
const showAllBtn = document.getElementById('showAll');

function humanFileSize(bytes){
  if(bytes === null) return '—';
  const thresh = 1024;
  if(Math.abs(bytes) < thresh) return bytes + ' B';
  const units = ['KB','MB','GB','TB'];
  let u = -1;
  do { bytes /= thresh; ++u; } while(Math.abs(bytes) >= thresh && u < units.length - 1);
  return bytes.toFixed(1) + ' ' + units[u];
}

function createCard(item){
  const card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = `
    <h3>${escapeHtml(item.name)}</h3>
    <div class="meta">Source miroir : <a href="${item.mirrorIndex}" target="_blank" rel="noopener">${item.mirrorIndex}</a></div>
    <div id="status-${item.id}" class="small">Recherche du dernier ISO...</div>
    <div class="row" style="margin-top:10px" id="buttons-${item.id}"></div>
    <div class="small" style="margin-top:8px">Page vérification : <a href="${item.verify}" target="_blank" rel="noopener">${item.verify}</a></div>
  `;
  return card;
}

function render(list){
  listEl.innerHTML = '';
  if(list.length === 0){ listEl.innerHTML = '<div class="card"><p>Aucun résultat</p></div>'; return; }
  list.forEach(i => listEl.appendChild(createCard(i)));
}

function escapeHtml(s){ return String(s).replace(/[&<>\"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c])); }

async function discoverLatest(item){
  const statusEl = document.getElementById(`status-${item.id}`);
  const buttonsEl = document.getElementById(`buttons-${item.id}`);
  try{
    if(item.id === 'windows11'){
      statusEl.innerHTML = `Windows 11 ne propose pas de lien ISO direct stable.<br><a href="${item.mirrorIndex}" target="_blank" rel="noopener">Ouvrir page officielle Microsoft</a>`;
      buttonsEl.innerHTML = `<a class="btn ghost" href="${item.mirrorIndex}" target="_blank" rel="noopener">Page Microsoft</a>`;
      return;
    }
    statusEl.textContent = 'Récupération de l’index du miroir via proxy CORS...';
    const res = await fetch(proxyURL + item.mirrorIndex, { method: 'GET' });
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const text = await res.text();
    // parse links from the HTML of index
    const doc = new DOMParser().parseFromString(text, 'text/html');
    const anchors = Array.from(doc.querySelectorAll('a'));
    const hrefs = anchors.map(a => a.getAttribute('href')).filter(Boolean);

    let isoCandidates = [];
    let torrentCandidates = [];
    if(item.isoPattern){
      const re = item.isoPattern;
      hrefs.forEach(h => {
        const name = h.split('/').pop();
        if(name && re.test(name)) isoCandidates.push({href: new URL(h, item.mirrorIndex).href, name});
        if(item.torrentPattern){
          const tRe = item.torrentPattern;
          if(tRe.test(name)) torrentCandidates.push({href: new URL(h, item.mirrorIndex).href, name});
        }
      });
    }

    // If index page contains subdirectories (eg ubuntu releases), try to descend into latest directory
    if(item.isoPattern && isoCandidates.length === 0){
      const dirCandidates = hrefs.filter(h => /\d{2}\.\d{2}\/|\d+\.\d+\/.+/.test(h) || /\d{2}\.\d{2}/.test(h)).slice(-6);
      for(const dir of dirCandidates){
        try{
          const dirUrl = new URL(dir, item.mirrorIndex).href;
          const r2 = await fetch(proxyURL + dirUrl);
          if(!r2.ok) continue;
          const t2 = await r2.text();
          const doc2 = new DOMParser().parseFromString(t2, 'text/html');
          const a2 = Array.from(doc2.querySelectorAll('a')).map(a=>a.getAttribute('href')).filter(Boolean);
          a2.forEach(h => {
            const name = h.split('/').pop();
            if(name && item.isoPattern.test(name)) isoCandidates.push({href: new URL(h, dirUrl).href, name});
            if(item.torrentPattern && item.torrentPattern.test(name)) torrentCandidates.push({href: new URL(h, dirUrl).href, name});
          });
          if(isoCandidates.length) break;
        }catch(e){}
      }
    }

    if(isoCandidates.length === 0){
      statusEl.innerHTML = `Aucun ISO détecté via fetch.<br><a href="${item.mirrorIndex}" target="_blank" rel="noopener">Ouvrir le répertoire miroir</a>`;
      buttonsEl.innerHTML = `<a class="btn ghost" href="${item.mirrorIndex}" target="_blank" rel="noopener">Ouvrir miroir</a>`;
      return;
    }

    isoCandidates.sort((a,b)=> b.name.localeCompare(a.name,'en',{numeric:true}));
    const best = isoCandidates[0];

    // HEAD request pour taille et date (via proxy)
    let size = null, lastModified = null;
    try{
      const head = await fetch(proxyURL + best.href, {method:'HEAD'});
      if(head.ok){
        size = head.headers.get('content-length');
        lastModified = head.headers.get('last-modified');
      }
    }catch(e){}

    statusEl.innerHTML = `Dernier ISO : <strong><a href="${best.href}" target="_blank" rel="noopener">${escapeHtml(best.name)}</a></strong>` +
                         `<div class="small">Taille : ${humanFileSize(size?parseInt(size):null)} — Date : ${lastModified?new Date(lastModified).toLocaleString(): '—'}</div>`;

    let torrentHtml = '';
    if(torrentCandidates.length){
      torrentCandidates.sort((a,b)=> b.name.localeCompare(a.name,'en',{numeric:true}));
      torrentHtml = `<a class="btn ghost" href="${torrentCandidates[0].href}" target="_blank" rel="noopener">Torrent</a>`;
    }

    buttonsEl.innerHTML = `
      <a class="btn primary" href="${best.href}" target="_blank" rel="noopener">Télécharger</a>
      ${torrentHtml}
      <a class="btn ghost" href="${item.verify}" target="_blank" rel="noopener">Vérifier</a>
    `;

  }catch(err){
    statusEl.innerHTML = `Erreur accès proxy ou miroir : ${escapeHtml(err.message)}.<br><a href="${item.mirrorIndex}" target="_blank" rel="noopener">Ouvrir miroir</a>`;
    document.getElementById(`buttons-${item.id}`).innerHTML = `<a class="btn ghost" href="${item.mirrorIndex}" target="_blank" rel="noopener">Ouvrir miroir</a><a class="btn ghost" href="${item.verify}" target="_blank" rel="noopener">Vérifier</a>`;
  }
}

async function init(){
  render(items);
  for(const it of items){
    await new Promise(r=>setTimeout(r, 300));
    discoverLatest(it);
  }
}

searchEl.addEventListener('input', ()=>{
  const q = searchEl.value.trim().toLowerCase();
  if(!q) return render(items);
  const filtered = items.filter(i => (i.name + ' ' + (i.id||'')).toLowerCase().includes(q));
  render(filtered);
});
refreshBtn.addEventListener('click', ()=> init());
showAllBtn.addEventListener('click', ()=> { searchEl.value=''; render(items); init(); });

init();
</script>
</body>
</html>
